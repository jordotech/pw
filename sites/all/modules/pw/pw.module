<?php

function pw_init(){

}

function pw_menu(){
    $items['grid'] = array(
        'title' => 'Grid',
        'description' => 'The Grid',
        'page callback' => 'pw_grid',
        'access callback' => TRUE,
    );
    return $items;
}

function pw_grid(){
    $output = '';
    $output .= '';

    $output .= '<div id="details"><div class="close-button"><i class="fa fa-eye-slash fa-4x"></i></div><div class="drop-in"></div></div>';
    $items = pw_grid_items(20);
    //debug($items);
    foreach($items as $key=>$value){
        $body = $value['body'];
        $grid = '<div onclick="itemDetail(' . $value['nid'] . ')" nid = "' . $value['nid'] . '" class="grid-item" tid="' . $value['tid'] . '">';

        $grid .= '<div class="grid-item-img">' . theme('image_style', array('style_name' => 'test', 'path' => $value['img_path'], 'alt' => 'image alt', 'title' => 'title',)) . '</div>';;
        $grid .= '<div class="grid-item-body">';
        $grid .= '<div class="body-category"><i class="fa ' . $value['icon'] . '"></i>  ' . $value['category'] . '</div>';
        $grid .= $value['body'] . '</div>';
        $grid .= '</div>';
        $output .= $grid;
    }
    return $output;
}

function extract_img_path($body){

    $src_pos = strpos($body, 'src');
    $a = substr($body, $src_pos);
    $b = strpos($a, '"')+2;

    $c = substr($body, ($src_pos + $b));
    $z = strpos($c, 'images');
    $c = substr($c, $z);
    $d = strpos($c, '"');
    $img_path = substr($c, 0, $d);

    if(strstr($img_path, 'images')){
        return $img_path;
    }else{
        return '';
    }
}
function pw_grid_items($limit, $tids = array()) {
    $nids = array();
    $query = db_select('node', 'n');
    $query->leftJoin('field_data_body;', 'fdb', 'n.nid = fdb.entity_id');

    $query->leftJoin('field_data_field_category', 'fdfc', 'n.nid = fdfc.entity_id');
    $query->leftJoin('taxonomy_term_data', 'ttd', 'fdfc.field_category_tid = ttd.tid');
    $query->leftJoin('field_data_field_category_icon', 'fdfci', 'fdfci.entity_id = ttd.tid');
    $query->condition('n.type', 'blog')
        ->orderBy('created', 'DESC')
        ->fields('n', array('nid', 'title', 'created'))
        ->fields('fdfc', array('field_category_tid'))
        ->fields('fdb', array('body_value'))
        ->fields('fdfci', array('field_category_icon_value'))
        ->fields('ttd', array('name'))
        ->range(0, $limit);
    $result = $query->execute();
    foreach ($result as $key => $value) {
        $img_path = extract_img_path($value->body_value);
        if($img_path != ''){
            $nids[] = array(
                'nid' => $value->nid,
                'title' => $value->title,
                'body' => $value->body_value,
                'tid' => $value->field_category_tid,
                'category' => $value->name,
                'img_path' => $img_path,
                'icon' => $value->field_category_icon_value,
            );
        }
    }
    return $nids;
}